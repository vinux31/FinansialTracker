---
phase: 06-financial-planning-goal-tracking
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Goal creation form successfully creates goal and displays it in list"
    - "Validation errors show specific messages instead of generic 'Failed to create goal'"
    - "Duplicate goal names show meaningful error to user"
  artifacts:
    - path: "src/lib/db.ts"
      provides: "createGoal() with InsertGoalSchema validation"
      contains: "InsertGoalSchema.safeParse"
      min_lines: 35
  key_links:
    - from: "src/components/goals/goal-form.tsx"
      to: "src/lib/db.ts createGoal()"
      via: "validated data submission"
      pattern: "createGoal\\(.*\\)"
---

<objective>
Fix goal creation validation to prevent generic "Failed to create goal" errors.

Purpose: Apply the proven validation pattern from createInvestment() to createGoal(), providing specific error messages for validation failures and database constraint violations.

Output: createGoal() function with schema validation and improved error handling, enabling successful goal creation with meaningful user feedback on failures.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:/Users/rinoa/Desktop/FinansialTracker/.planning/PROJECT.md
@C:/Users/rinoa/Desktop/FinansialTracker/.planning/ROADMAP.md
@C:/Users/rinoa/Desktop/FinansialTracker/.planning/STATE.md
@C:/Users/rinoa/Desktop/FinansialTracker/.planning/phases/06-financial-planning-goal-tracking/06-01-SUMMARY.md
@C:/Users/rinoa/Desktop/FinansialTracker/.planning/phases/06-financial-planning-goal-tracking/06-UAT.md
@C:/Users/rinoa/Desktop/FinansialTracker/.planning/debug/goal-creation-fails.md
</context>

<tasks>

<task type="auto">
  <name>Add InsertGoalSchema validation to createGoal() function</name>
  <files>src/lib/db.ts</files>
  <action>
Update createGoal() function (lines 446-472) to match the validation pattern from createInvestment() (lines 253-315):

1. Import InsertGoalSchema from schema.ts (like line 265)
2. Add timestamp generation before validation (like line 262)
3. Add schema validation using InsertGoalSchema.safeParse() before database insert
4. Include all required fields in validation object: user_id, name, category, target_amount, deadline, priority, funding_notes, status
5. Throw descriptive error on validation failure with console.error logging
6. Update database error handling to check for specific constraint violations:
   - Check error.code === '23505' for unique constraint violation (duplicate goal name)
   - Throw "A goal with this name already exists" for duplicate names
   - Console.error the full error object for debugging
   - Keep generic "Failed to create goal" as fallback for other errors

Reference pattern: createInvestment() (lines 265-280) validates before insert, logs errors to console, provides specific error messages.

Using InsertGoalSchema per Phase 06-01 decision - schema already exists and includes future deadline validation.
  </action>
  <verify>
Read src/lib/db.ts lines 446-490 and confirm:
- InsertGoalSchema import exists
- safeParse() validation happens before database insert
- Validation failure logs to console.error and throws "Invalid goal data"
- Database error checks for code '23505' (unique constraint)
- Duplicate name throws "A goal with this name already exists"
  </verify>
  <done>
createGoal() function includes InsertGoalSchema.safeParse() validation matching createInvestment() pattern, with specific error messages for validation failures and duplicate goal name constraint violations.
  </done>
</task>

</tasks>

<verification>
**After completion, verify gap closure:**

1. Check UAT Test 2 passes:
   - Fill goal form with name, category, target amount, deadline, priority, funding notes
   - Submit form
   - Goal appears in list immediately
   - Form resets

2. Test validation error messages:
   - Try creating goal with past deadline → should show validation error (not generic "Failed to create goal")
   - Try creating goal with duplicate name → should show "A goal with this name already exists"

3. Check console for validation errors (if any occur):
   - Console.error should show detailed validation failure information
   - Console.error should show database error details for debugging
</verification>

<success_criteria>
- [ ] createGoal() includes InsertGoalSchema.safeParse() validation before database insert
- [ ] Validation failures log to console.error and throw "Invalid goal data"
- [ ] Duplicate goal name constraint violations throw "A goal with this name already exists"
- [ ] Goal creation form successfully creates goals and displays them in list (UAT Test 2 passes)
- [ ] All changes committed to git with gap closure reference
</success_criteria>

<output>
After completion, create `.planning/phases/06-financial-planning-goal-tracking/06-05-SUMMARY.md` following the standard summary template.
</output>
