---
phase: 06-financial-planning-goal-tracking
plan: 04
type: execute
wave: 3
depends_on: [06-02, 06-03]
files_modified:
  - src/app/(dashboard)/page.tsx
  - src/components/goals/kpi-dashboard.tsx
  - src/components/goals/risk-indicator.tsx
  - src/lib/export.ts
autonomous: true

must_haves:
  truths:
    - User sees KPI dashboard on main page showing saving rate, goal progress, and timeline adherence
    - User can export goals and progress data as part of CSV export
    - Risk indicators show HIGH/MEDIUM/LOW status for each goal
  artifacts:
    - path: src/components/goals/kpi-dashboard.tsx
      provides: KPI cards with saving rate, goal progress, timeline adherence
      exports: ["KPIDashboard"]
    - path: src/components/goals/risk-indicator.tsx
      provides: Risk badge component
      exports: ["RiskIndicator"]
    - path: src/lib/export.ts
      provides: Extended CSV export including goals
      contains: "GOALS section"
  key_links:
    - from: src/components/goals/kpi-dashboard.tsx
      to: lib/goals/calculations
      via: calculateSavingsRate
      pattern: "calculateSavingsRate\\("
    - from: src/lib/export.ts
      to: db.getGoals
      via: export function
      pattern: "getGoals\\(\\)"
---

<objective>
Add KPI dashboard to main page and extend CSV export to include goals and progress tracking data.

Purpose: Surface key financial planning metrics on dashboard and enable full data export for backup/analysis.
Output: KPI dashboard cards integrated into main page, extended CSV export with goals section.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-financial-planning-goal-tracking/06-CONTEXT.md
@.planning/phases/06-financial-planning-goal-tracking/06-RESEARCH.md
@.planning/phases/06-financial-planning-goal-tracking/06-01-SUMMARY.md
@.planning/phases/06-financial-planning-goal-tracking/06-02-SUMMARY.md
@.planning/phases/06-financial-planning-goal-tracking/06-03-SUMMARY.md

Existing dashboard and export patterns:
@src/app/(dashboard)/page.tsx
@src/lib/export.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KPI dashboard and risk indicator components</name>
  <files>src/components/goals/kpi-dashboard.tsx, src/components/goals/risk-indicator.tsx</files>
  <action>
**Create risk-indicator.tsx:**
```typescript
interface RiskIndicatorProps {
  level: 'LOW' | 'MEDIUM' | 'HIGH'
  label?: string
}

export function RiskIndicator({ level, label }: RiskIndicatorProps) {
  const config = {
    LOW: { color: 'bg-green-100 text-green-800 border-green-300', text: 'On Track' },
    MEDIUM: { color: 'bg-yellow-100 text-yellow-800 border-yellow-300', text: 'Warning' },
    HIGH: { color: 'bg-red-100 text-red-800 border-red-300', text: 'Critical' },
  }[level]

  return (
    <span className={`inline-flex items-center px-2 py-1 text-xs font-medium border rounded ${config.color}`}>
      {label || config.text}
    </span>
  )
}
```

**Create kpi-dashboard.tsx:**
```typescript
'use client'

import { useEffect, useState } from 'react'
import { getGoals, getGoalProgress } from '@/lib/db'
import { calculateGoalProgress, calculateSavingsRate } from '@/lib/goals/calculations'
import { getTimelineRisk } from '@/lib/goals/status'
import { RiskIndicator } from './risk-indicator'
import { IDR } from '@/lib/money'
import type { Goal, ProgressEntry } from '@/types'

export function KPIDashboard() {
  const [goals, setGoals] = useState<Goal[]>([])
  const [progressEntries, setProgressEntries] = useState<ProgressEntry[]>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    async function load() {
      try {
        const goalsData = await getGoals()
        setGoals(goalsData)

        const allProgress: ProgressEntry[] = []
        for (const goal of goalsData) {
          const progress = await getGoalProgress(goal.id)
          allProgress.push(...progress)
        }
        setProgressEntries(allProgress)
      } catch (err) {
        console.error('Failed to load KPI data:', err)
      } finally {
        setLoading(false)
      }
    }
    load()
  }, [])

  if (loading) {
    return <div className="text-gray-500 text-sm">Loading goal metrics...</div>
  }

  if (goals.length === 0) {
    return (
      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
        <p className="text-sm text-blue-800">
          Create financial goals to see your progress metrics
        </p>
      </div>
    )
  }

  // Calculate metrics
  const totalGoals = goals.length
  const completedGoals = goals.filter(g => {
    const { totalSaved } = calculateGoalProgress(g, progressEntries)
    return totalSaved >= g.target_amount
  }).length

  const overallProgress = goals.reduce((sum, goal) => {
    const { percentComplete } = calculateGoalProgress(goal, progressEntries)
    return sum + percentComplete
  }, 0) / totalGoals

  // Timeline adherence (count of on-track goals)
  const onTrackGoals = goals.filter(g => {
    const { totalSaved } = calculateGoalProgress(g, progressEntries)
    const risk = getTimelineRisk(g, totalSaved)
    return risk === 'LOW'
  }).length

  const adherencePercent = Math.round((onTrackGoals / totalGoals) * 100)

  // Determine overall timeline risk
  const timelineRisk: 'LOW' | 'MEDIUM' | 'HIGH' =
    adherencePercent >= 70 ? 'LOW' :
    adherencePercent >= 40 ? 'MEDIUM' : 'HIGH'

  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
      {/* Goal Progress KPI */}
      <div className="bg-white border rounded-lg p-4">
        <div className="text-sm text-gray-600 mb-1">Goal Progress</div>
        <div className="text-2xl font-bold mb-2">
          {Math.round(overallProgress)}%
        </div>
        <div className="text-xs text-gray-500">
          {completedGoals} of {totalGoals} goals completed
        </div>
      </div>

      {/* Timeline Adherence KPI */}
      <div className="bg-white border rounded-lg p-4">
        <div className="text-sm text-gray-600 mb-1">Timeline Adherence</div>
        <div className="flex items-center gap-2 mb-2">
          <span className="text-2xl font-bold">{adherencePercent}%</span>
          <RiskIndicator level={timelineRisk} />
        </div>
        <div className="text-xs text-gray-500">
          {onTrackGoals} of {totalGoals} goals on track
        </div>
      </div>

      {/* Active Goals KPI */}
      <div className="bg-white border rounded-lg p-4">
        <div className="text-sm text-gray-600 mb-1">Active Goals</div>
        <div className="text-2xl font-bold mb-2">{totalGoals}</div>
        <div className="text-xs text-gray-500">
          {goals.filter(g => g.status === 'in-progress').length} in progress
        </div>
      </div>
    </div>
  )
}
```

Follow user requirements:
- Numeric-only progress (text "Rp 50jt / Rp 100jt (50%)" not progress bars)
- Risk indicators with traffic light colors (LOW=green, MEDIUM=yellow, HIGH=red)
- Card grid layout per Claude's discretion
- Core KPIs: goal progress %, timeline adherence, active goals count
  </action>
  <verify>
grep "export function RiskIndicator" src/components/goals/risk-indicator.tsx
grep "export function KPIDashboard" src/components/goals/kpi-dashboard.tsx
grep "calculateGoalProgress" src/components/goals/kpi-dashboard.tsx
grep "getTimelineRisk" src/components/goals/kpi-dashboard.tsx
  </verify>
  <done>RiskIndicator shows LOW/MEDIUM/HIGH badges with traffic light colors. KPIDashboard displays 3 KPI cards (goal progress %, timeline adherence, active goals) with numeric values and risk indicators.</done>
</task>

<task type="auto">
  <name>Task 2: Add KPI dashboard to main page</name>
  <files>src/app/(dashboard)/page.tsx</files>
  <action>
Update main dashboard page to include KPI dashboard above existing charts:

Find the main page content area (after the "Dashboard" heading) and add KPIDashboard component:

```typescript
import { KPIDashboard } from '@/components/goals/kpi-dashboard'

// In the page component, add before CategoryBreakdown:
<div className="mb-6">
  <h2 className="text-xl font-semibold mb-3">Financial Planning Goals</h2>
  <KPIDashboard />
</div>
```

Position KPI dashboard as a new section between page header and existing CategoryBreakdown chart. Follow existing layout structure with consistent spacing.
  </action>
  <verify>
grep "import.*KPIDashboard" src/app/(dashboard)/page.tsx
grep "Financial Planning Goals" src/app/(dashboard)/page.tsx
  </verify>
  <done>Main dashboard page includes KPIDashboard component showing goal metrics above existing charts.</done>
</task>

<task type="auto">
  <name>Task 3: Extend CSV export to include goals and progress</name>
  <files>src/lib/export.ts</files>
  <action>
Extend exportFinancialData function following Phase 4 pattern (multi-section CSV with blank row separators):

**Add goals to export function signature:**
```typescript
import type { Goal, ProgressEntry } from '@/types'

export function exportFinancialData(
  transactions: Transaction[],
  investments: DatabaseInvestment[],
  goals: Goal[],
  progressEntries: ProgressEntry[]
): string {
  // ... existing code for transactions and investments sections ...

  // Add GOALS section after investments
  csvContent += '\n\n' // Blank row separator

  csvContent += 'GOALS\n'
  csvContent += 'Name,Category,Target Amount,Deadline,Priority,Status,Funding Notes\n'

  for (const goal of goals) {
    csvContent += [
      goal.name,
      goal.category,
      goal.target_amount.toString(),
      goal.deadline,
      goal.priority,
      goal.status,
      `"${goal.funding_notes.replace(/"/g, '""')}"`, // Escape quotes
    ].join(',') + '\n'
  }

  // Add GOAL PROGRESS section
  csvContent += '\n' // Blank row separator

  csvContent += 'GOAL PROGRESS\n'
  csvContent += 'Goal Name,Month,Planned Amount,Actual Amount,Notes\n'

  // Map goal IDs to names for readability
  const goalNames = new Map(goals.map(g => [g.id, g.name]))

  for (const entry of progressEntries) {
    const goalName = goalNames.get(entry.goal_id) || 'Unknown Goal'
    csvContent += [
      goalName,
      entry.month,
      entry.planned_amount.toString(),
      entry.actual_amount.toString(),
      `"${entry.notes.replace(/"/g, '""')}"`,
    ].join(',') + '\n'
  }

  return BOM + csvContent
}
```

**Update history page to pass goals:**
In history/page.tsx, load goals and progress, then pass to export function:
```typescript
const goals = await getGoals()
const allProgress: ProgressEntry[] = []
for (const goal of goals) {
  const progress = await getGoalProgress(goal.id)
  allProgress.push(...progress)
}

const csv = exportFinancialData(transactions, investments, goals, allProgress)
```

Follow Phase 4 CSV structure:
- Blank row separators between sections
- Headers for each section (TRANSACTIONS, INVESTMENTS, GOALS, GOAL PROGRESS)
- Quote escaping for text fields
- BOM prefix for Excel compatibility
  </action>
  <verify>
grep "GOALS" src/lib/export.ts
grep "GOAL PROGRESS" src/lib/export.ts
grep "Goal.*ProgressEntry" src/lib/export.ts
  </verify>
  <done>export.ts includes GOALS and GOAL PROGRESS sections in CSV output with proper formatting, quote escaping, and blank row separators matching existing multi-section pattern.</done>
</task>

<task type="auto">
  <name>Task 4: Update history page CSV export to include goals</name>
  <files>src/app/(dashboard)/history/page.tsx</files>
  <action>
Update history page to load and export goals:

**Add imports:**
```typescript
import { getGoals, getGoalProgress } from '@/lib/db'
import type { ProgressEntry } from '@/types'
```

**In the component, load goals alongside transactions:**
```typescript
const [goals, setGoals] = useState<Goal[]>([])
const [progressEntries, setProgressEntries] = useState<ProgressEntry[]>([])

// In useEffect where transactions are loaded:
useEffect(() => {
  async function loadData() {
    try {
      setLoading(true)
      const [txs, invs, goalsData] = await Promise.all([
        getTransactions(),
        getInvestments(),
        getGoals(),
      ])

      setTransactions(txs)
      setInvestments(invs)
      setGoals(goalsData)

      // Load progress for all goals
      const allProgress: ProgressEntry[] = []
      for (const goal of goalsData) {
        const progress = await getGoalProgress(goal.id)
        allProgress.push(...progress)
      }
      setProgressEntries(allProgress)
    } catch (err) {
      console.error('Failed to load data:', err)
    } finally {
      setLoading(false)
    }
  }
  loadData()
}, [])
```

**Update handleExport:**
```typescript
const handleExport = () => {
  const csv = exportFinancialData(transactions, investments, goals, progressEntries)
  // ... rest of export code unchanged
}
```

Follow existing pattern of Promise.all for parallel loading, maintain existing loading states and error handling.
  </action>
  <verify>
grep "getGoals" src/app/(dashboard)/history/page.tsx
grep "getGoalProgress" src/app/(dashboard)/history/page.tsx
grep "exportFinancialData.*goals.*progressEntries" src/app/(dashboard)/history/page.tsx
  </verify>
  <done>History page loads goals and progress entries, passes them to exportFinancialData for complete CSV export including all financial data.</done>
</task>

</tasks>

<verification>
Run after all tasks:
1. Verify KPIDashboard shows 3 KPI cards with numeric values
2. Verify RiskIndicator uses traffic light colors (green/yellow/red)
3. Verify main dashboard page includes KPI section
4. Verify CSV export includes GOALS and GOAL PROGRESS sections
5. Verify history page exports complete dataset
</verification>

<success_criteria>
- Main dashboard shows KPI cards with goal progress %, timeline adherence %, and active goal count
- Risk indicators display LOW/MEDIUM/HIGH with traffic light colors
- KPI values update based on actual goal and progress data
- CSV export includes 4 sections: TRANSACTIONS, INVESTMENTS, GOALS, GOAL PROGRESS
- Goals section shows name, category, target, deadline, priority, status, funding notes
- Progress section shows goal name, month, planned, actual, notes
- Export button on history page downloads complete financial dataset
- Blank row separators between CSV sections for Excel readability
</success_criteria>

<output>
After completion, create `.planning/phases/06-financial-planning-goal-tracking/06-04-SUMMARY.md`
</output>
