---
phase: 01-foundation-core-tracking
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/components/income-form.tsx
  - src/lib/export.ts
  - src/app/(dashboard)/history/page.tsx
  - src/app/(dashboard)/monthly/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can log income with amount and optional notes"
    - "User can view complete transaction history with all entries"
    - "User can view monthly summary showing total spent and breakdown by category"
    - "User can export all data as CSV for backup or analysis"
  artifacts:
    - path: "src/components/income-form.tsx"
      provides: "Income entry form"
      contains: "incomeSchema"
    - path: "src/lib/export.ts"
      provides: "CSV export functionality"
      contains: "papaparse"
    - path: "src/app/(dashboard)/history/page.tsx"
      provides: "Transaction history list"
      contains: "getTransactions"
    - path: "src/app/(dashboard)/monthly/page.tsx"
      provides: "Monthly summary with category breakdown"
      contains: "getMonthSummary"
  key_links:
    - from: "src/components/income-form.tsx"
      to: "src/lib/storage.ts"
      via: "addIncome call on form submit"
      pattern: "addIncome"
    - from: "src/app/(dashboard)/history/page.tsx"
      to: "src/lib/storage.ts"
      via: "reads all transactions"
      pattern: "getTransactions"
    - from: "src/app/(dashboard)/monthly/page.tsx"
      to: "src/lib/storage.ts"
      via: "reads month summary"
      pattern: "getMonthSummary"
    - from: "src/lib/export.ts"
      to: "src/lib/storage.ts"
      via: "reads all transactions for export"
      pattern: "getTransactions"
---

<objective>
Build the income form, transaction history page, monthly summary page, and CSV export -- completing all remaining Phase 1 features.

Purpose: Provide full transaction visibility (history, monthly breakdown) and data portability (CSV export) alongside income tracking.
Output: Working income form, transaction history page, monthly summary page, and CSV export button.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-core-tracking/01-RESEARCH.md
@.planning/phases/01-foundation-core-tracking/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create income form and CSV export utility</name>
  <files>
    src/components/income-form.tsx
    src/lib/export.ts
  </files>
  <action>
    Create `src/components/income-form.tsx` -- income entry form:

    - 'use client' component
    - Similar structure to expense form but simpler: amount + notes fields only (no category -- income has fixed 'Income' category)
    - Validate with `incomeSchema.safeParse()` from validation.ts
    - On submit: call `addIncome()` from storage, reset form
    - Accept `onIncomeAdded` callback prop for parent refresh
    - Use shadcn/ui Button, Input, Label components
    - Style to visually distinguish from expense form (e.g., green accent instead of default)

    Create `src/lib/export.ts` -- CSV export using Papa Parse:

    ```typescript
    import Papa from 'papaparse'
    import { getTransactions } from '@/lib/storage'
    import { formatIDR } from '@/lib/money'

    export function exportTransactionsCSV(): void {
      const transactions = getTransactions()

      if (transactions.length === 0) {
        alert('No transactions to export')
        return
      }

      // Map to human-readable format
      const rows = transactions.map(tx => ({
        Date: tx.date,
        Time: tx.timestamp,
        Type: tx.type,
        Category: tx.category,
        Amount: tx.amount,
        'Amount (Formatted)': formatIDR(tx.amount),
        Notes: tx.notes,
      }))

      const csv = Papa.unparse(rows, {
        header: true,
      })

      // Add BOM for Excel compatibility with Indonesian characters
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' })
      const url = URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = url
      link.download = `finance-tracker-${new Date().toISOString().slice(0, 10)}.csv`
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      URL.revokeObjectURL(url)
    }
    ```

    Include BOM (`\ufeff`) prefix for Excel compatibility with Indonesian category names per research recommendations.
  </action>
  <verify>
    `npx tsc --noEmit` passes. Income form component compiles. Export function compiles.
  </verify>
  <done>
    Income form accepts amount and notes, validates with Zod, saves via addIncome(). CSV export generates downloadable file with all transactions including BOM for Excel compatibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build transaction history and monthly summary pages</name>
  <files>
    src/app/(dashboard)/history/page.tsx
    src/app/(dashboard)/monthly/page.tsx
  </files>
  <action>
    Create `src/app/(dashboard)/history/page.tsx` -- transaction history:

    - 'use client' component
    - Load all transactions in useEffect (hydration guard)
    - Display as a list/table sorted by timestamp descending (newest first)
    - Each row shows: date, type (expense/income), category, amount (formatted as IDR), notes
    - Color-code: expenses in red/default, income in green
    - Include the CSV export button at the top of the page (calls `exportTransactionsCSV()` from export.ts)
    - Handle empty state: "No transactions yet. Start by adding an expense!"
    - Include the IncomeForm component on this page (income logging is less frequent than expense, so it lives on the history page rather than the main Today page)
    - Use a `refreshKey` pattern: increment when income is added to refresh the transaction list
    - Use shadcn/ui Card for each transaction or a clean table layout

    Create `src/app/(dashboard)/monthly/page.tsx` -- monthly summary:

    - 'use client' component
    - Load transactions in useEffect
    - Derive available months using `getUniqueMonths()` from date.ts
    - Default to current month via `currentMonthString()`
    - Month selector: dropdown or tabs to switch between months
    - For selected month, show via `getMonthSummary()`:
      - Total expenses (prominent, large IDR format)
      - Total income (prominent, green)
      - Net (income - expenses)
      - Category breakdown: list each of the 5 categories with their total spending
      - Show each category as a row: category name, amount, percentage of total expenses
    - Handle empty state for months with no data
    - Use shadcn/ui Card components for sections
    - Style category amounts with proper IDR formatting via `formatIDR()`
  </action>
  <verify>
    `npm run build` succeeds. History page at `/history` shows transactions. Monthly page at `/monthly` shows summary with category breakdown.
  </verify>
  <done>
    Transaction history shows all entries sorted by date (newest first) with income form and CSV export button. Monthly summary shows total expenses, income, net, and per-category breakdown for the selected month. Both pages load data from localStorage safely.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. Navigate to `/history` -- see empty state or transaction list, income form, export button
3. Add income on history page -- list updates with new income entry
4. Click CSV export -- file downloads with proper headers and data
5. Navigate to `/monthly` -- see current month summary
6. Add expenses/income on Today page, verify monthly summary reflects them
7. Category breakdown shows all 5 categories with amounts
</verification>

<success_criteria>
- Income form logs income correctly (amount + notes, type='income', category='Income')
- Transaction history shows all transactions sorted newest first
- CSV export downloads valid CSV file with BOM for Excel compatibility
- Monthly summary shows totals and per-category breakdown
- Month selector allows viewing different months
- All pages handle empty states gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-tracking/01-03-SUMMARY.md`
</output>
