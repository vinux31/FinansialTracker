---
phase: 04-investment-portfolio-tracking
plan: 03
type: execute
wave: 3
depends_on: [04-02]
files_modified:
  - src/components/portfolio-summary.tsx
  - src/lib/investments.ts
  - src/app/(dashboard)/investments/page.tsx
  - src/components/investment-list.tsx
autonomous: true

must_haves:
  truths:
    - "User sees total portfolio value calculated from all investments"
    - "User sees gain/loss calculation (current value - contribution)"
    - "User sees breakdown by category (Saham, Emas, Reksadana)"
    - "User can edit existing investment values"
    - "User can delete investments"
  artifacts:
    - path: "src/lib/investments.ts"
      provides: "Portfolio calculation utilities"
      exports: ["usePortfolioMetrics", "PortfolioMetrics"]
    - path: "src/components/portfolio-summary.tsx"
      provides: "Portfolio metrics display component"
      exports: ["PortfolioSummary"]
    - path: "src/components/investment-list.tsx"
      provides: "Investment list with edit/delete actions"
      contains: "Edit and Delete buttons"
  key_links:
    - from: "src/lib/investments.ts"
      to: "currency.js"
      via: "useMemo with Currency arithmetic"
      pattern: "new Currency\\("
    - from: "src/components/portfolio-summary.tsx"
      to: "usePortfolioMetrics"
      via: "hook call with investments array"
      pattern: "usePortfolioMetrics\\(investments\\)"
    - from: "src/components/investment-list.tsx"
      to: "updateInvestment and deleteInvestment"
      via: "button onClick handlers"
      pattern: "(updateInvestment|deleteInvestment)\\("
---

<objective>
Add portfolio summary calculations, edit/delete investment functionality, and visual metrics display.

Purpose: Enable users to see portfolio performance and manage investments (INV-04, partial INV-05).
Output: Portfolio summary component with gain/loss metrics, edit/delete buttons in investment list, calculation utilities with useMemo optimization.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-investment-portfolio-tracking/04-RESEARCH.md

# Phase 4 prior plans
@.planning/phases/04-investment-portfolio-tracking/04-01-SUMMARY.md
@.planning/phases/04-investment-portfolio-tracking/04-02-SUMMARY.md

# Chart calculation pattern
@src/lib/chart-data.ts
@src/components/charts/category-breakdown.tsx

# Edit/delete pattern
@src/components/transaction-actions.tsx
@src/app/(dashboard)/history/page.tsx

# Database operations
@src/lib/db.ts
</context>

<tasks>

<task type="auto">
  <name>Create portfolio calculation utilities</name>
  <files>src/lib/investments.ts</files>
  <action>
Create investment calculation utilities following chart-data.ts pattern (useMemo for performance).

**Export interface:**
```typescript
export interface PortfolioMetrics {
  totalContributed: number
  totalValue: number
  totalGain: number
  gainPercent: number
  byCategory: Record<string, CategoryMetrics>
}

export interface CategoryMetrics {
  count: number
  totalValue: number
  totalContributed: number
  totalGain: number
}
```

**Export hook:**
```typescript
export function usePortfolioMetrics(investments: DatabaseInvestment[]): PortfolioMetrics
```

**Implementation:**
Use useMemo with investments as dependency (same pattern as aggregateByCategory in chart-data.ts).

Calculate:
1. totalValue = sum of all current_value fields (using currency.js: new Currency(total).add(inv.current_value))
2. totalContributed = sum of all monthly_contribution fields
3. totalGain = totalValue - totalContributed
4. gainPercent = (totalGain / totalContributed) * 100 (handle division by zero)

5. byCategory object for Saham, Emas, Reksadana:
   - For each investment, add to category bucket
   - Calculate count, totalValue, totalContributed, totalGain per category
   - Use currency.js for all arithmetic to avoid floating-point errors

**Currency.js usage:**
```typescript
import Currency from 'currency.js'

// Addition
totalValue = new Currency(totalValue).add(inv.current_value).intValue

// Subtraction
totalGain = new Currency(totalValue).subtract(totalContributed).intValue
```

Return memoized metrics object.

Import: Currency from 'currency.js', useMemo from 'react', DatabaseInvestment from @/lib/supabase/schema.

Follow exact useMemo pattern from chart-data.ts (dependency array, intValue for integers).
  </action>
  <verify>
```bash
# Check utilities exist
grep -q "export function usePortfolioMetrics" src/lib/investments.ts
grep -q "PortfolioMetrics" src/lib/investments.ts
grep -q "currency.js" src/lib/investments.ts
grep -q "useMemo" src/lib/investments.ts
```
  </verify>
  <done>investments.ts exports usePortfolioMetrics hook with PortfolioMetrics interface, uses useMemo for performance, calculates totals and category breakdowns with currency.js</done>
</task>

<task type="auto">
  <name>Create portfolio summary component</name>
  <files>src/components/portfolio-summary.tsx</files>
  <action>
Create PortfolioSummary component to display portfolio metrics.

**Component signature:**
```typescript
'use client'
import type { DatabaseInvestment } from '@/lib/supabase/schema'

interface PortfolioSummaryProps {
  investments: DatabaseInvestment[]
}
export function PortfolioSummary({ investments }: PortfolioSummaryProps)
```

**Implementation:**
- Call usePortfolioMetrics(investments) to get metrics
- Use formatCurrency from @/lib/money for display

**Display structure:**

1. **Top row (2-column grid):**
   - Total Portfolio Value card (blue background, large font)
     - Label: "Total Value"
     - Value: formatCurrency(metrics.totalValue)
   - Gain/Loss card (green if positive, red if negative)
     - Label: "Gain/Loss"
     - Value: "+/-" + formatCurrency(metrics.totalGain)
     - Percentage: "(X.X%)"

2. **Category breakdown (3-column grid below):**
   - Saham card: count, total value
   - Emas card: count, total value
   - Reksadana card: count, total value
   - Gray background, smaller cards

**Styling:**
- Use Tailwind grid: grid-cols-2 gap-4 for top row, grid-cols-3 gap-2 for categories
- Cards: p-4 rounded shadow or bg-color with padding
- Conditional colors: gainPercent >= 0 ? 'text-green-600' : 'text-red-600'
- Match dashboard card style from other components

**Empty state:** If investments.length === 0, show message "Add investments to see portfolio summary"

Import: usePortfolioMetrics from @/lib/investments, formatCurrency from @/lib/money.
  </action>
  <verify>
```bash
# Check component structure
grep -q "export function PortfolioSummary" src/components/portfolio-summary.tsx
grep -q "usePortfolioMetrics" src/components/portfolio-summary.tsx
grep -q "formatCurrency" src/components/portfolio-summary.tsx
```
  </verify>
  <done>PortfolioSummary component displays total value, gain/loss with percentage, and category breakdown; shows empty state for no investments</done>
</task>

<task type="auto">
  <name>Add edit and delete functionality to investment list</name>
  <files>src/components/investment-list.tsx</files>
  <action>
Extend InvestmentList component with edit and delete actions, following transaction-actions.tsx pattern.

**Add props:**
```typescript
interface InvestmentListProps {
  investments: DatabaseInvestment[]
  onUpdate: () => void  // Callback after edit/delete to refresh list
}
```

**For each investment card, add action buttons:**
1. Edit button - opens inline edit mode or simple prompt
2. Delete button - confirms and deletes

**Edit implementation (simple approach - inline edit mode):**
- Add state: editingId (string | null), editForm (object with current_value, notes)
- Edit button: Sets editingId to investment.id, populates editForm
- Show edit form inline when editingId === investment.id
- Edit form fields: current_value (number input), notes (textarea)
- Save button: Calls updateInvestment(id, { current_value: parseInt(value), notes }), then onUpdate()
- Cancel button: Clears editingId

**Delete implementation:**
- Delete button: Shows confirm dialog (window.confirm, same as transaction delete)
- Message: "Delete investment {name}? This cannot be undone."
- On confirm: Call deleteInvestment(id), then onUpdate()
- Handle errors with console.error and alert

**Styling:**
- Edit/Delete buttons: text-blue-600 and text-red-600, text-sm
- Inline edit form: border, rounded, p-2, bg-gray-50
- Loading state during save/delete (disable buttons)

Import: updateInvestment, deleteInvestment from @/lib/db.

Follow Phase 2 transaction edit pattern (Today page has edit modal, but inline is simpler for this).
  </action>
  <verify>
```bash
# Check edit/delete functionality
grep -q "updateInvestment" src/components/investment-list.tsx
grep -q "deleteInvestment" src/components/investment-list.tsx
grep -q "editingId" src/components/investment-list.tsx
grep -q "confirm" src/components/investment-list.tsx
```
  </verify>
  <done>InvestmentList component shows Edit and Delete buttons for each investment, edit mode updates current_value and notes inline, delete requires confirmation</done>
</task>

<task type="auto">
  <name>Add portfolio summary to investments page</name>
  <files>src/app/(dashboard)/investments/page.tsx</files>
  <action>
Update investments page to include PortfolioSummary component at the top.

**Layout order (update existing page):**
1. Page heading: "Investment Portfolio"
2. **NEW: PortfolioSummary component** - Pass investments array
3. Divider
4. InvestmentForm - Keep existing (onSuccess callback)
5. Section heading: "Your Investments"
6. **UPDATED: InvestmentList** - Add onUpdate={handleRefresh} prop

**Changes:**
- Import PortfolioSummary from @/components/portfolio-summary
- Add <PortfolioSummary investments={investments} /> after heading, before form
- Update InvestmentList props to include onUpdate={handleRefresh}
- Add spacing/margin between sections (mb-6, mt-8, etc)

**Refresh flow:**
- Form submission → handleRefresh → reloads investments → summary and list update
- Edit/delete in list → onUpdate callback → handleRefresh → updates

No new state needed, just add component and wire up callbacks.

Styling: Keep container pattern, add visual separation between sections (borders, spacing).
  </action>
  <verify>
```bash
# Check page updates
grep -q "PortfolioSummary" src/app/\\(dashboard\\)/investments/page.tsx
grep -q "onUpdate" src/app/\\(dashboard\\)/investments/page.tsx
```
  </verify>
  <done>Investments page shows PortfolioSummary at top with metrics, InvestmentForm below, InvestmentList at bottom with edit/delete actions; all sections refresh on data changes</done>
</task>

</tasks>

<verification>
**Portfolio management complete when:**
1. User sees portfolio summary with total value, gain/loss, and category breakdown
2. Metrics update when investments are added/edited/deleted
3. User can click Edit on investment to update current value and notes
4. User can click Delete with confirmation to remove investment
5. All calculations use currency.js (no floating-point errors)
6. Page performance is good with useMemo optimization
</verification>

<success_criteria>
- PortfolioSummary displays accurate totals using usePortfolioMetrics hook
- Edit functionality updates investment current_value and notes in database
- Delete functionality removes investment after confirmation
- All monetary calculations use currency.js for precision
- TypeScript compiles without errors
- Components follow existing patterns from Phase 2 charts and transaction management
</success_criteria>

<output>
After completion, create `.planning/phases/04-investment-portfolio-tracking/04-03-SUMMARY.md`
</output>
