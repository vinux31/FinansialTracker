---
phase: 04-investment-portfolio-tracking
plan: 04
type: execute
wave: 4
depends_on: [04-03]
files_modified:
  - src/components/navigation.tsx
  - src/app/(dashboard)/monthly/page.tsx
  - src/lib/export.ts
autonomous: true

must_haves:
  truths:
    - "User can navigate to investments page from main navigation"
    - "User sees investment summary on monthly page alongside expenses"
    - "User can export investments as part of CSV download"
    - "CSV contains both transactions and investments in separate sections"
  artifacts:
    - path: "src/components/navigation.tsx"
      provides: "Navigation link to investments page"
      contains: "Investments"
    - path: "src/app/(dashboard)/monthly/page.tsx"
      provides: "Monthly view with investment summary"
      contains: "PortfolioSummary"
    - path: "src/lib/export.ts"
      provides: "Extended CSV export with investments"
      exports: ["exportFinancialData"]
  key_links:
    - from: "src/components/navigation.tsx"
      to: "/investments route"
      via: "Link href"
      pattern: "href=\"/investments\""
    - from: "src/app/(dashboard)/monthly/page.tsx"
      to: "getInvestments"
      via: "useEffect data fetch"
      pattern: "getInvestments\\(\\)"
    - from: "src/lib/export.ts"
      to: "PapaParse"
      via: "unparse with investments data"
      pattern: "Papa\\.unparse"
---

<objective>
Integrate investments into navigation, monthly summary view, and CSV export functionality.

Purpose: Complete Phase 4 by making investments accessible and exportable (INV-05, INV-06).
Output: Navigation link, monthly page investment section, extended CSV export with transactions and investments.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-investment-portfolio-tracking/04-RESEARCH.md

# Phase 4 prior plans
@.planning/phases/04-investment-portfolio-tracking/04-01-SUMMARY.md
@.planning/phases/04-investment-portfolio-tracking/04-02-SUMMARY.md
@.planning/phases/04-investment-portfolio-tracking/04-03-SUMMARY.md

# Navigation pattern
@src/components/navigation.tsx

# Monthly summary page
@src/app/(dashboard)/monthly/page.tsx

# CSV export
@src/lib/export.ts
</context>

<tasks>

<task type="auto">
  <name>Add investments link to navigation</name>
  <files>src/components/navigation.tsx</files>
  <action>
Update Navigation component to include link to investments page.

**Add navigation item after "History" link:**
- Text: "Investments"
- href: "/investments"
- Use same Link component and styling as existing nav items
- Active state highlighting (pathname === '/investments')

**Order:**
1. Dashboard (/)
2. History (/history)
3. Monthly (/monthly)
4. **NEW: Investments (/investments)**

Follow exact pattern from existing navigation items (className with conditional active state, Link from next/link).

Styling: Match existing nav item classes (text color, hover state, active underline or background).
  </action>
  <verify>
```bash
# Check navigation link exists
grep -q "Investments" src/components/navigation.tsx
grep -q "/investments" src/components/navigation.tsx
```
  </verify>
  <done>Navigation component includes "Investments" link with active state highlighting matching other nav items</done>
</task>

<task type="auto">
  <name>Add investment summary to monthly page</name>
  <files>src/app/(dashboard)/monthly/page.tsx</files>
  <action>
Update monthly page to load and display investment portfolio summary alongside expense breakdown.

**Add to page:**
1. Import getInvestments from @/lib/db, PortfolioSummary from @/components/portfolio-summary, DatabaseInvestment type
2. Add state: const [investments, setInvestments] = useState&lt;DatabaseInvestment[]&gt;([])
3. Update useEffect to load both transactions AND investments:
   ```typescript
   useEffect(() => {
     async function loadData() {
       try {
         const [txs, invs] = await Promise.all([
           getTransactions(),
           getInvestments()
         ])
         setTransactions(txs)
         setInvestments(invs)
         setLoading(false)
       } catch (error) {
         // handle error
       }
     }
     loadData()
   }, [selectedMonth])
   ```

4. Add section after expense summary:
   - Heading: "Investment Portfolio" (h2, text-xl font-semibold mt-8 mb-4)
   - PortfolioSummary component with investments prop
   - This shows current portfolio value, not historical (Phase 4 requirements don't include historical tracking)

**Layout:**
- Keep existing monthly expense breakdown at top
- Add portfolio section below with spacing
- Loading state applies to both sections

**Note:** Portfolio summary shows current state (not filtered by month like transactions). This is correct per requirements (INV-05 says "investment summary in monthly view", not "monthly investment changes").

Follow existing page pattern for loading states and error handling.
  </action>
  <verify>
```bash
# Check monthly page updates
grep -q "getInvestments" src/app/\\(dashboard\\)/monthly/page.tsx
grep -q "PortfolioSummary" src/app/\\(dashboard\\)/monthly/page.tsx
grep -q "Investment Portfolio" src/app/\\(dashboard\\)/monthly/page.tsx
```
  </verify>
  <done>Monthly page loads investments alongside transactions, displays PortfolioSummary component below expense breakdown, uses Promise.all for parallel data loading</done>
</task>

<task type="auto">
  <name>Extend CSV export to include investments</name>
  <files>src/lib/export.ts</files>
  <action>
Update CSV export functionality to include investment data following research pattern (separate sections).

**Update exportTransactions function signature and implementation:**

Rename to `exportFinancialData` and update:

```typescript
export function exportFinancialData(
  transactions: DatabaseTransaction[],
  investments: DatabaseInvestment[]
)
```

**CSV structure (update unparse data):**

1. **TRANSACTIONS section:**
   - Header row: ['TRANSACTIONS']
   - Column headers: ['Date', 'Type', 'Amount (IDR)', 'Category', 'Notes']
   - Transaction rows: map transactions to arrays

2. **Blank row:** []

3. **INVESTMENTS section:**
   - Header row: ['INVESTMENTS']
   - Column headers: ['Name', 'Category', 'Monthly Contribution (IDR)', 'Current Value (IDR)', 'Purchase Date', 'Notes']
   - Investment rows: map investments to arrays

4. **Blank row:** []

5. **SUMMARY section:**
   - Header row: ['SUMMARY']
   - Total Expenses: calculate with currency.js
   - Total Income: calculate with currency.js
   - Total Investments: sum of current_value with currency.js

**Implementation:**
```typescript
const exportData: any[] = [
  ['TRANSACTIONS'],
  ['Date', 'Type', 'Amount (IDR)', 'Category', 'Notes'],
  ...transactions.map(tx => [tx.date, tx.type, tx.amount, tx.category, tx.notes]),
  [],
  ['INVESTMENTS'],
  ['Name', 'Category', 'Monthly Contribution (IDR)', 'Current Value (IDR)', 'Purchase Date', 'Notes'],
  ...investments.map(inv => [inv.name, inv.category, inv.monthly_contribution, inv.current_value, inv.purchase_date, inv.notes || '']),
  [],
  ['SUMMARY'],
  ['Total Expenses', calculateTotalExpenses(transactions)],
  ['Total Income', calculateTotalIncome(transactions)],
  ['Total Investments', calculateTotalInvestments(investments)]
]

const csv = Papa.unparse(exportData)
```

**Update BOM handling:** Keep existing UTF-8 BOM prefix for Excel compatibility.

**Filename:** Update to `finansial-export-YYYY-MM-DD.csv` (keep existing date format logic).

Import: DatabaseInvestment from @/lib/supabase/schema, Currency from 'currency.js' for calculations.

Update all call sites to pass investments array (history page, other pages with export button).
  </action>
  <verify>
```bash
# Check export updates
grep -q "exportFinancialData" src/lib/export.ts
grep -q "INVESTMENTS" src/lib/export.ts
grep -q "DatabaseInvestment" src/lib/export.ts
```
  </verify>
  <done>export.ts exports exportFinancialData function that generates CSV with TRANSACTIONS section, INVESTMENTS section, and SUMMARY section with totals</done>
</task>

<task type="auto">
  <name>Update CSV export call sites</name>
  <files>src/app/(dashboard)/history/page.tsx</files>
  <action>
Update history page to pass investments to CSV export function.

**Changes:**
1. Import getInvestments from @/lib/db, DatabaseInvestment type
2. Add state: const [investments, setInvestments] = useState&lt;DatabaseInvestment[]&gt;([])
3. Update useEffect to load investments: call getInvestments(), setInvestments(result)
4. Update export button onClick handler:
   - Change from exportTransactions(transactions) to exportFinancialData(transactions, investments)
   - Import exportFinancialData instead of exportTransactions

**Pattern:** Follow same Promise.all pattern as monthly page for loading both datasets.

**Error handling:** Add investments to existing error handling (show error if either load fails).

No UI changes needed, just wire up investments data to export function.
  </action>
  <verify>
```bash
# Check history page updates
grep -q "getInvestments" src/app/\\(dashboard\\)/history/page.tsx
grep -q "exportFinancialData" src/app/\\(dashboard\\)/history/page.tsx
```
  </verify>
  <done>History page loads investments data and passes both transactions and investments to exportFinancialData function</done>
</task>

</tasks>

<verification>
**Phase 4 integration complete when:**
1. User can click "Investments" in navigation to reach investments page
2. Monthly page shows investment portfolio summary below expense data
3. CSV export includes both transactions and investments sections
4. Downloaded CSV opens correctly in Excel with Indonesian text (BOM preserved)
5. All navigation and data flows work without errors
</verification>

<success_criteria>
- Navigation includes Investments link with active state
- Monthly page displays current portfolio summary alongside expense breakdown
- CSV export contains TRANSACTIONS, INVESTMENTS, and SUMMARY sections
- Export button on history page passes both datasets
- TypeScript compiles without errors
- All Phase 4 requirements (INV-01 through INV-06) are implemented
</success_criteria>

<output>
After completion, create `.planning/phases/04-investment-portfolio-tracking/04-04-SUMMARY.md`
</output>
