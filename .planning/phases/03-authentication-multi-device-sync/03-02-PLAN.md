---
phase: 03-authentication-multi-device-sync
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/lib/auth.ts
  - src/app/auth/signup/page.tsx
  - src/app/auth/login/page.tsx
  - src/app/auth/callback/route.ts
  - src/app/(dashboard)/layout.tsx
  - src/components/navigation.tsx
autonomous: true

must_haves:
  truths:
    - "User can create account with email and password"
    - "User receives email verification link after signup"
    - "User can log in with verified email and password"
    - "User can log out and session ends"
    - "Protected pages redirect to login when not authenticated"
  artifacts:
    - path: "src/lib/auth.ts"
      provides: "Authentication helper functions"
      exports: ["signUp", "signIn", "signOut", "getSession"]
    - path: "src/app/auth/signup/page.tsx"
      provides: "Signup page with form"
      min_lines: 50
    - path: "src/app/auth/login/page.tsx"
      provides: "Login page with form"
      min_lines: 50
    - path: "src/app/auth/callback/route.ts"
      provides: "OAuth/email callback handler"
      min_lines: 15
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Protected route layout with auth check"
      contains: "getUser()"
  key_links:
    - from: "src/app/auth/signup/page.tsx"
      to: "src/lib/auth.ts"
      via: "signUp function call"
      pattern: "signUp\\("
    - from: "src/app/(dashboard)/layout.tsx"
      to: "supabase.auth.getUser()"
      via: "authentication check"
      pattern: "getUser\\(\\)"
    - from: "src/components/navigation.tsx"
      to: "src/lib/auth.ts"
      via: "signOut function call"
      pattern: "signOut\\("
---

<objective>
Implement user authentication flow with email/password signup, login, logout, and protected routes.

Purpose: Enable users to create accounts and securely access their data from any device with proper session management.

Output: Working authentication system with signup/login pages, email verification, protected dashboard, and logout functionality.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-authentication-multi-device-sync/03-RESEARCH.md
@.planning/phases/03-authentication-multi-device-sync/03-01-SUMMARY.md

Current components:
@src/components/navigation.tsx
@src/app/(dashboard)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Create authentication utility functions</name>
  <files>src/lib/auth.ts</files>
  <action>
Create auth helper functions for signup, login, logout, and session management using browser Supabase client.

**src/lib/auth.ts**:
```typescript
'use client'

import { createClient } from '@/lib/supabase/client'

const supabase = createClient()

export async function signUp(email: string, password: string) {
  const { data, error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      emailRedirectTo: `${location.origin}/auth/callback`,
    },
  })

  if (error) throw error
  return data
}

export async function signIn(email: string, password: string) {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  })

  if (error) throw error
  return data
}

export async function signOut() {
  const { error } = await supabase.auth.signOut()
  if (error) throw error
}

export async function getSession() {
  const { data, error } = await supabase.auth.getSession()
  if (error) throw error
  return data.session
}

export async function getUser() {
  const { data, error } = await supabase.auth.getUser()
  if (error) throw error
  return data.user
}
```

Notes:
- Use 'use client' directive - these functions run in browser only
- emailRedirectTo handles email verification callback
- signInWithPassword is correct method (not signIn which is for OAuth)
- Client-side functions for forms/components, server uses different pattern
  </action>
  <verify>src/lib/auth.ts exists and exports signUp, signIn, signOut, getSession, getUser</verify>
  <done>Authentication helper functions created for client-side auth operations</done>
</task>

<task type="auto">
  <name>Create signup page</name>
  <files>src/app/auth/signup/page.tsx</files>
  <action>
Create signup page with email/password form and validation.

**src/app/auth/signup/page.tsx**:
```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { signUp } from '@/lib/auth'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import Link from 'next/link'

export default function SignupPage() {
  const router = useRouter()
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [confirmPassword, setConfirmPassword] = useState('')
  const [error, setError] = useState('')
  const [loading, setLoading] = useState(false)
  const [success, setSuccess] = useState(false)

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    setError('')
    setLoading(true)

    // Client-side validation
    if (password !== confirmPassword) {
      setError('Passwords do not match')
      setLoading(false)
      return
    }

    if (password.length < 8) {
      setError('Password must be at least 8 characters')
      setLoading(false)
      return
    }

    try {
      await signUp(email, password)
      setSuccess(true)
      // User will receive email verification link
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to sign up')
    } finally {
      setLoading(false)
    }
  }

  if (success) {
    return (
      <div className="flex min-h-screen items-center justify-center p-4">
        <Card className="w-full max-w-md">
          <CardHeader>
            <CardTitle>Check your email</CardTitle>
            <CardDescription>
              We sent a verification link to {email}. Click the link to verify your account and log in.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button onClick={() => router.push('/auth/login')} className="w-full">
              Go to Login
            </Button>
          </CardContent>
        </Card>
      </div>
    )
  }

  return (
    <div className="flex min-h-screen items-center justify-center p-4">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle>Create an account</CardTitle>
          <CardDescription>Enter your email to get started with Finance Tracker</CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input
                id="email"
                type="email"
                placeholder="you@example.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
                autoFocus
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="password">Password</Label>
              <Input
                id="password"
                type="password"
                placeholder="At least 8 characters"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="confirmPassword">Confirm Password</Label>
              <Input
                id="confirmPassword"
                type="password"
                placeholder="Repeat password"
                value={confirmPassword}
                onChange={(e) => setConfirmPassword(e.target.value)}
                required
              />
            </div>
            {error && (
              <div className="rounded-md bg-red-50 p-3 text-sm text-red-800">
                {error}
              </div>
            )}
            <Button type="submit" className="w-full" disabled={loading}>
              {loading ? 'Creating account...' : 'Sign up'}
            </Button>
            <p className="text-center text-sm text-gray-600">
              Already have an account?{' '}
              <Link href="/auth/login" className="text-blue-600 hover:underline">
                Log in
              </Link>
            </p>
          </form>
        </CardContent>
      </Card>
    </div>
  )
}
```

Features:
- Password confirmation validation
- 8 character minimum password length
- Email verification message after signup
- Link to login page for existing users
- Loading states during submission
- Error display for validation failures
  </action>
  <verify>src/app/auth/signup/page.tsx exists with form for email, password, and password confirmation</verify>
  <done>Signup page created with email/password form and validation</done>
</task>

<task type="auto">
  <name>Create login page</name>
  <files>src/app/auth/login/page.tsx</files>
  <action>
Create login page with email/password form and redirect to dashboard after successful login.

**src/app/auth/login/page.tsx**:
```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { signIn } from '@/lib/auth'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import Link from 'next/link'

export default function LoginPage() {
  const router = useRouter()
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState('')
  const [loading, setLoading] = useState(false)

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    setError('')
    setLoading(true)

    try {
      await signIn(email, password)
      router.push('/')
      router.refresh() // Refresh server components to load user data
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to log in')
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="flex min-h-screen items-center justify-center p-4">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle>Welcome back</CardTitle>
          <CardDescription>Log in to your Finance Tracker account</CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input
                id="email"
                type="email"
                placeholder="you@example.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
                autoFocus
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="password">Password</Label>
              <Input
                id="password"
                type="password"
                placeholder="Your password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
              />
            </div>
            {error && (
              <div className="rounded-md bg-red-50 p-3 text-sm text-red-800">
                {error}
              </div>
            )}
            <Button type="submit" className="w-full" disabled={loading}>
              {loading ? 'Logging in...' : 'Log in'}
            </Button>
            <p className="text-center text-sm text-gray-600">
              Don't have an account?{' '}
              <Link href="/auth/signup" className="text-blue-600 hover:underline">
                Sign up
              </Link>
            </p>
          </form>
        </CardContent>
      </Card>
    </div>
  )
}
```

Features:
- Simple email/password form
- Redirects to dashboard after successful login
- router.refresh() ensures server components reload with authenticated session
- Error display for invalid credentials
- Link to signup page for new users
  </action>
  <verify>src/app/auth/login/page.tsx exists with email/password form and redirect logic</verify>
  <done>Login page created with authentication and dashboard redirect</done>
</task>

<task type="auto">
  <name>Create email verification callback route</name>
  <files>src/app/auth/callback/route.ts</files>
  <action>
Create callback route to handle email verification links from Supabase.

**src/app/auth/callback/route.ts**:
```typescript
import { createClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'

export async function GET(request: Request) {
  const requestUrl = new URL(request.url)
  const code = requestUrl.searchParams.get('code')

  if (code) {
    const supabase = await createClient()
    await supabase.auth.exchangeCodeForSession(code)
  }

  // Redirect to dashboard after email verification
  return NextResponse.redirect(new URL('/', requestUrl.origin))
}
```

Flow:
1. User clicks verification link in email
2. Supabase redirects to /auth/callback?code=...
3. exchangeCodeForSession validates code and creates session
4. User redirected to dashboard (now authenticated)

This handles:
- Email verification after signup
- Password reset links (future enhancement)
- Magic link authentication (future enhancement)
  </action>
  <verify>src/app/auth/callback/route.ts exists and exports GET handler</verify>
  <done>Email verification callback route created</done>
</task>

<task type="auto">
  <name>Protect dashboard routes with authentication</name>
  <files>src/app/(dashboard)/layout.tsx</files>
  <action>
Update dashboard layout to check authentication and redirect unauthenticated users to login.

**Replace src/app/(dashboard)/layout.tsx** with protected version:
```typescript
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import Navigation from '@/components/navigation'

export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const supabase = await createClient()

  // CRITICAL: Use getUser() not getSession() - validates token with Supabase Auth
  const { data, error } = await supabase.auth.getUser()

  if (error || !data?.user) {
    redirect('/auth/login')
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <Navigation userEmail={data.user.email} />
      <main className="container mx-auto p-4 max-w-6xl">
        {children}
      </main>
    </div>
  )
}
```

Key changes:
- Import createClient from server utilities (not browser)
- Call getUser() to validate session (makes request to Supabase Auth)
- Redirect to /auth/login if no valid user
- Pass user email to Navigation for display
- Preserves existing container/layout styling

Security:
- getUser() validates JWT signature with Supabase (cannot be spoofed)
- Server-side check runs before page renders (no flash of protected content)
- Middleware already refreshed token, so this check uses fresh session
  </action>
  <verify>src/app/(dashboard)/layout.tsx imports createClient from server and redirects unauthenticated users</verify>
  <done>Dashboard layout protects all routes with server-side authentication check</done>
</task>

<task type="auto">
  <name>Add logout button to navigation</name>
  <files>src/components/navigation.tsx</files>
  <action>
Update Navigation component to accept user email and add logout button.

**Update src/components/navigation.tsx**:

First, read the current implementation to preserve existing styles and structure.

Then update to:
1. Accept `userEmail?: string` prop
2. Add logout button in top-right if user is authenticated
3. Use signOut() from auth.ts
4. Redirect to /auth/login after logout

Add this code at the top (client directive):
```typescript
'use client'
```

Add to component props:
```typescript
export default function Navigation({ userEmail }: { userEmail?: string })
```

Add logout handler:
```typescript
import { signOut } from '@/lib/auth'
import { useRouter } from 'next/navigation'

// Inside component:
const router = useRouter()

async function handleLogout() {
  try {
    await signOut()
    router.push('/auth/login')
    router.refresh()
  } catch (error) {
    console.error('Logout failed:', error)
  }
}
```

Add logout button to nav (after links, before closing nav tag):
```typescript
{userEmail && (
  <div className="flex items-center gap-4">
    <span className="text-sm text-gray-600">{userEmail}</span>
    <Button variant="outline" size="sm" onClick={handleLogout}>
      Log out
    </Button>
  </div>
)}
```

Import Button:
```typescript
import { Button } from '@/components/ui/button'
```

Preserve:
- Existing navigation links structure
- Active state highlighting logic
- Container/spacing styles
- Link component usage
  </action>
  <verify>Navigation component has logout button that appears when userEmail prop is provided</verify>
  <done>Navigation updated with user email display and logout functionality</done>
</task>

</tasks>

<verification>
Run these checks to confirm authentication is working:

1. **Signup flow:**
   ```bash
   npm run dev
   # Visit http://localhost:3000/auth/signup
   # Enter email (use real email you can access)
   # Enter password (min 8 chars)
   # Confirm password
   # Submit form
   # Verify "Check your email" message appears
   ```

2. **Email verification:**
   - Check email inbox for verification link
   - Click link
   - Verify redirect to dashboard (http://localhost:3000)

3. **Login flow:**
   ```bash
   # Visit http://localhost:3000/auth/login
   # Enter verified email and password
   # Submit form
   # Verify redirect to dashboard
   # Verify email displayed in navigation
   # Verify logout button appears
   ```

4. **Logout flow:**
   - Click "Log out" button
   - Verify redirect to /auth/login
   - Try to visit http://localhost:3000 directly
   - Verify redirect to /auth/login (protected route)

5. **TypeScript compilation:**
   ```bash
   npm run build
   ```
   Expected: No type errors
</verification>

<success_criteria>
- Signup page accepts email/password and shows verification message
- Login page accepts credentials and redirects to dashboard
- Email verification callback creates session and redirects to dashboard
- Dashboard layout checks authentication and redirects unauthenticated users
- Navigation shows user email and logout button for authenticated users
- Logout clears session and redirects to login page
- Protected routes redirect to login when not authenticated
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentication-multi-device-sync/03-02-SUMMARY.md`
</output>
