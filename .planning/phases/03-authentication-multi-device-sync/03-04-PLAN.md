---
phase: 03-authentication-multi-device-sync
plan: 04
type: execute
wave: 4
depends_on: [03-03]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can create account and verify email successfully"
    - "User can log in and access dashboard with their data"
    - "User can add transactions that save to Supabase"
    - "User can access same data from different devices"
    - "User's existing localStorage data migrates without data loss"
    - "User's data is isolated from other users (RLS working)"
  artifacts:
    - path: "supabase/migrations/001_initial_schema.sql"
      provides: "Applied database schema"
      validation: "Table exists in Supabase Dashboard"
    - path: "supabase/migrations/002_rls_policies.sql"
      provides: "Applied RLS policies"
      validation: "Policies visible in Supabase Dashboard"
  key_links:
    - from: "All components"
      to: "Supabase database"
      via: "working CRUD operations"
      pattern: "No errors in browser console"
---

<objective>
Verify Phase 3 implementation through comprehensive end-to-end testing of authentication, data migration, and multi-device synchronization.

Purpose: Ensure all authentication flows work correctly, data migrates safely, and users can access their data from multiple devices without data leakage.

Output: Verified working authentication system with confirmed multi-user data isolation and successful migration path.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-authentication-multi-device-sync/03-RESEARCH.md
@.planning/phases/03-authentication-multi-device-sync/03-01-SUMMARY.md
@.planning/phases/03-authentication-multi-device-sync/03-02-SUMMARY.md
@.planning/phases/03-authentication-multi-device-sync/03-03-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete authentication system with:
- User signup and email verification
- Login/logout functionality
- Protected dashboard routes
- Data migration from localStorage to Supabase
- Multi-device data synchronization
- Row-Level Security for data isolation
  </what-built>
  <how-to-verify>

## Test Suite: Phase 3 Verification

### 1. Authentication Flow (New User)

**Signup:**
1. Clear browser data (localStorage, cookies) or use incognito
2. Visit http://localhost:3000
3. Expect: Redirect to /auth/login (no session)
4. Click "Sign up" link
5. Enter email address (use real email you can access)
6. Enter password (minimum 8 characters)
7. Confirm password
8. Click "Sign up"
9. Expect: "Check your email" message

**Email Verification:**
10. Check email inbox for verification link
11. Click verification link
12. Expect: Redirect to dashboard (http://localhost:3000)
13. Expect: Email displayed in navigation
14. Expect: "Log out" button visible

**Login:**
15. Click "Log out"
16. Expect: Redirect to /auth/login
17. Enter same email and password
18. Click "Log in"
19. Expect: Redirect to dashboard
20. Expect: Session persists across page refreshes

### 2. Database Operations (Single User)

**Add Expense:**
1. Log in to dashboard
2. Enter amount (e.g., 50000)
3. Select category (e.g., Makan)
4. Add notes (e.g., "Test expense")
5. Click "Add Expense"
6. Expect: Form clears
7. Expect: Transaction appears in Today's Transactions list
8. Expect: Today's total updates

**Verify in Supabase:**
9. Open Supabase Dashboard (https://supabase.com/dashboard)
10. Navigate to Table Editor -> transactions
11. Expect: Row exists with your user_id
12. Expect: amount = 50000, category = "Makan"

**Add Income:**
13. Navigate to History page
14. Scroll to Income form
15. Enter amount (e.g., 5000000)
16. Add notes (e.g., "Test income")
17. Click "Add Income"
18. Expect: Income appears in transaction list
19. Expect: Green color for income entry

**Edit Transaction (Today only):**
20. Navigate to Today page (/)
21. Find test expense
22. Click edit button
23. Change amount to 75000
24. Change notes to "Updated test"
25. Click "Save"
26. Expect: Transaction updates immediately
27. Expect: Today's total recalculates

**Delete Transaction:**
28. Click delete button on test expense
29. Expect: Confirmation dialog
30. Click "OK"
31. Expect: Transaction removed from list
32. Expect: Today's total recalculates

### 3. Data Migration (Existing User)

**Setup localStorage data:**
1. Open browser console
2. Run:
```javascript
localStorage.setItem('finance-tracker-transactions', JSON.stringify([
  {
    id: 'test-1',
    type: 'expense',
    amount: 100000,
    category: 'Transportasi',
    notes: 'Migration test 1',
    date: '2026-02-10',
    timestamp: '2026-02-10T10:00:00Z',
    createdAt: '2026-02-10T10:00:00Z'
  },
  {
    id: 'test-2',
    type: 'expense',
    amount: 50000,
    category: 'Makan',
    notes: 'Migration test 2',
    date: '2026-02-15',
    timestamp: '2026-02-15T12:00:00Z',
    createdAt: '2026-02-15T12:00:00Z'
  },
  {
    id: 'test-3',
    type: 'income',
    amount: 3000000,
    category: 'Income',
    notes: 'Migration test income',
    date: '2026-02-01',
    timestamp: '2026-02-01T09:00:00Z',
    createdAt: '2026-02-01T09:00:00Z'
  }
]))
```
3. Refresh page
4. Expect: Redirect to /migrate
5. Expect: Message showing "3 transactions" to migrate
6. Click "Migrate X Transactions"
7. Expect: "Migrating..." message
8. Expect: "Migration Complete" message after a few seconds
9. Click "Go to Dashboard"
10. Expect: All 3 transactions visible in History
11. Open browser console
12. Run: `localStorage.getItem('finance-tracker-transactions')`
13. Expect: `null` (localStorage cleared after successful migration)

**Verify migration in Supabase:**
14. Open Supabase Dashboard -> Table Editor -> transactions
15. Expect: 3 new rows with migrated data
16. Verify all amounts, categories, and dates match

### 4. Multi-Device Synchronization

**Setup:**
1. Open two different browsers (e.g., Chrome and Firefox)
   OR open same browser in normal and incognito mode
   OR use different devices (desktop + mobile)
2. Log in with SAME account in both browsers

**Browser 1 → Browser 2 sync:**
3. Browser 1: Add new expense (amount: 25000, category: Rokok)
4. Browser 2: Wait 2-3 seconds, refresh page
5. Expect: New expense appears in Browser 2
6. Verify: Same transaction ID in both browsers

**Browser 2 → Browser 1 sync:**
7. Browser 2: Add new income (amount: 1000000)
8. Browser 1: Refresh page
9. Expect: Income appears in Browser 1
10. Verify: Today's total matches in both browsers

**Real-time test (if Realtime subscription is active):**
11. Browser 1: Add expense
12. Browser 2: Watch dashboard (no refresh)
13. Expect: New expense appears automatically within 1-2 seconds
    Note: If not automatic, manual refresh is acceptable for MVP

### 5. Data Isolation (Multi-User RLS)

**Create second user:**
1. Log out from current account
2. Sign up with different email (e.g., test2@example.com)
3. Verify email
4. Log in with second account

**Verify isolation:**
5. Navigate to History page
6. Expect: Empty transaction list (no data from first user)
7. Add test expense for second user
8. Open Supabase Dashboard -> Table Editor -> transactions
9. Filter by user_id of first account
10. Expect: Only first user's transactions visible
11. Filter by user_id of second account
12. Expect: Only second user's transactions visible
13. Verify: No overlap between users

**Cross-account access test:**
14. Try to manually query with wrong user_id:
    - Open browser console while logged in as user 2
    - Run Supabase query for user 1's data
    - Expect: Empty result (RLS blocks access)

### 6. Edge Cases

**Session expiration:**
1. Log in
2. Wait for session to expire (default: 1 hour) OR manually delete auth cookies
3. Try to add expense
4. Expect: Redirect to login OR error message about session

**Network errors:**
1. Open browser DevTools -> Network tab
2. Set network to "Offline"
3. Try to add expense
4. Expect: Error message (not silent failure)
5. Set network to "Online"
6. Retry
7. Expect: Success

**Concurrent edits (if testing real-time):**
1. Browser 1 and 2 logged in as same user
2. Browser 1: Edit transaction X
3. Browser 2: Edit same transaction X at same time
4. Both save
5. Expect: Last write wins (second save overwrites first)

## Success Criteria

All tests must pass with these results:

✅ Signup creates account and sends verification email
✅ Email verification creates valid session
✅ Login works with verified credentials
✅ Logout clears session and redirects to login
✅ Protected routes redirect when not authenticated
✅ Transactions save to Supabase (confirmed in dashboard)
✅ localStorage data migrates with count verification
✅ Migration clears localStorage only after verification
✅ Multi-device access shows same data
✅ RLS prevents cross-user data access
✅ Edit and delete operations work correctly
✅ Charts and summaries render with database data
✅ No console errors during normal operations

## Expected Issues (Acceptable)

⚠️ Real-time sync requires manual refresh - ACCEPTABLE for MVP (Realtime subscription is optional enhancement)
⚠️ Session expiration requires re-login - EXPECTED behavior
⚠️ Network errors show error messages - EXPECTED behavior

## Blocker Issues (Must Fix)

❌ Cannot create account - BLOCKER
❌ Migration loses data - BLOCKER
❌ RLS allows cross-user access - BLOCKER (security issue)
❌ Transactions don't save to database - BLOCKER
❌ Dashboard doesn't load user's data - BLOCKER

  </how-to-verify>
  <resume-signal>
Type "verified" if all success criteria pass.
If any blocker issues found, type "blocked: [description]" with specific error details.
If acceptable issues found, type "verified with notes: [description]" to document limitations.
  </resume-signal>
</task>

</tasks>

<verification>
Phase 3 is complete when all must-have truths are verified:

1. **Authentication truths:**
   - User can create account with email/password
   - Email verification creates valid session
   - Login redirects to dashboard
   - Logout clears session and redirects to login
   - Protected routes redirect unauthenticated users

2. **Data operation truths:**
   - New transactions save to Supabase (not localStorage)
   - Transactions appear in Supabase Dashboard with correct user_id
   - Edit and delete operations work
   - Charts and summaries render from database

3. **Migration truths:**
   - localStorage data detected automatically
   - Migration counts match (X localStorage = X Supabase)
   - Migration verification prevents partial data loss
   - localStorage cleared only after successful verification

4. **Multi-user truths:**
   - User A cannot see User B's transactions
   - RLS policies enforce user_id filtering
   - Each user's data isolated in Supabase

5. **Multi-device truths:**
   - Same account on two devices shows same data
   - Changes on one device visible on other (after refresh or real-time)
</verification>

<success_criteria>
- All 5 test suites pass without blocker issues
- Supabase Dashboard shows transactions with correct user_id values
- RLS policies prevent cross-user data access
- Migration completes without data loss
- Multi-device access confirmed working
- No critical console errors during normal operations
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentication-multi-device-sync/03-04-SUMMARY.md`

Include in summary:
- Test results for all 5 suites
- Any acceptable limitations documented
- Confirmation of security (RLS working)
- Migration success rate
- Multi-device sync behavior (real-time or refresh-based)
</output>
