---
phase: 03-authentication-multi-device-sync
plan: 05
type: execute
wave: 1
depends_on: []
files_modified: [src/app/(dashboard)/monthly/page.tsx]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Charts render with database data without hook order errors"
    - "Monthly summary page renders without hook violations"
    - "useMemo hook called consistently on every render"
  artifacts:
    - path: "src/app/(dashboard)/monthly/page.tsx"
      provides: "MonthlyPage component with correct hook ordering"
      min_lines: 175
      contains: "useMemo"
  key_links:
    - from: "src/app/(dashboard)/monthly/page.tsx"
      to: "useMemo hook"
      via: "called before any conditional returns"
      pattern: "useMemo.*aggregateByCategory"
---

<objective>
Fix React Hooks ordering violation in MonthlyPage component.

Purpose: Ensure consistent hook count across all renders by moving useMemo before conditional early return.
Output: MonthlyPage component that renders without hook order errors.
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-authentication-multi-device-sync/03-UAT.md
@.planning/debug/monthly-page-hooks-violation.md
@src/app/(dashboard)/monthly/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move useMemo hook before conditional return</name>
  <files>src/app/(dashboard)/monthly/page.tsx</files>
  <action>
Move the useMemo hook (lines 71-74) to execute BEFORE the conditional early return (lines 58-67).

**Current problematic structure:**
- Lines 22-26: 5 useState hooks
- Lines 28-44: useEffect #1
- Lines 46-56: useEffect #2
- Lines 58-67: Conditional return (when !summary) ← PROBLEM: early return
- Lines 68-74: useMemo ← PROBLEM: only called when summary exists

**Fixed structure:**
- Lines 22-26: 5 useState hooks
- Lines 28-44: useEffect #1
- Lines 46-56: useEffect #2
- Lines 68-74: useMemo ← MOVED: now called on every render
- Lines 58-67: Conditional return ← Still early return, but after all hooks

**Specific changes:**
1. Move lines 68-74 (const net, const hasData, and useMemo) to position BEFORE line 58
2. The useMemo can safely be called even when summary is null - aggregateByCategory will handle empty data
3. Ensure all hook dependencies remain correct

**Why this works:**
- All 8 hooks (5 useState + 2 useEffect + 1 useMemo) now execute on every render
- Early return only affects JSX, not hook execution
- Hook count is consistent: 8 hooks every time, regardless of summary state

**Do NOT:**
- Remove the early return (it's fine after all hooks are called)
- Change the logic of the component
- Modify the useMemo dependencies unnecessarily
  </action>
  <verify>
npm run build
Expected: Build succeeds with no TypeScript errors or React warnings
  </verify>
  <done>
MonthlyPage component compiles without hook order violations. All hooks execute in consistent order on every render.
  </done>
</task>

</tasks>

<verification>
1. Build verification: `npm run build` passes with no errors
2. Hook order verification: Inspect component - all hooks called before any conditional returns
3. Runtime verification: Navigate to /monthly page - no console errors about hook ordering
4. Functional verification: Monthly page displays correctly with charts and summaries
</verification>

<success_criteria>
- [ ] MonthlyPage component builds without TypeScript errors
- [ ] All React hooks (useState, useEffect, useMemo) called before conditional returns
- [ ] Monthly page renders without hook order warnings in console
- [ ] Charts and summaries display correctly
- [ ] UAT tests 14 and 15 can be re-run successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentication-multi-device-sync/03-05-SUMMARY.md`
</output>
