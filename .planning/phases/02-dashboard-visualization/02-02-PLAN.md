---
phase: 02-dashboard-visualization
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/charts/trend-comparison.tsx
  - src/app/(dashboard)/monthly/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees trend line chart showing spending over multiple months"
    - "User can select time range via dropdown (3 months, 6 months, or 12 months)"
    - "Chart displays Income vs Expense as two separate trend lines"
    - "User sees percentage change vs previous month"
    - "User sees average spending across selected time range"
    - "Chart displays even with only 1-2 months of data"
  artifacts:
    - path: "src/components/charts/trend-comparison.tsx"
      provides: "Multi-month trend line chart with time range selector"
      min_lines: 60
    - path: "src/app/(dashboard)/monthly/page.tsx"
      provides: "Monthly page with trend chart below category chart"
      contains: "TrendComparison"
  key_links:
    - from: "src/components/charts/trend-comparison.tsx"
      to: "recharts"
      via: "ResponsiveContainer + LineChart"
      pattern: "ResponsiveContainer.*LineChart"
    - from: "src/components/charts/trend-comparison.tsx"
      to: "src/lib/chart-data.ts"
      via: "aggregateByMonth with useMemo"
      pattern: "useMemo.*aggregateByMonth"
    - from: "src/components/charts/trend-comparison.tsx"
      to: "native select"
      via: "time range dropdown"
      pattern: "select.*3 months.*6 months.*12 months"
---

<objective>
Create multi-month trend comparison chart with time range selector for Monthly page

Purpose: Enable month-to-month spending analysis with income vs expense comparison
Output: Working trend line chart with 3/6/12 month selector, percentage change, and average metrics
</objective>

<execution_context>
@C:/Users/rinoa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rinoa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dashboard-visualization/02-CONTEXT.md
@.planning/phases/02-dashboard-visualization/02-RESEARCH.md

## Phase 1 Foundation
@.planning/phases/01-foundation-core-tracking/01-01-SUMMARY.md
@.planning/phases/01-foundation-core-tracking/01-02-SUMMARY.md

## Plan 02-01 (requires Recharts and chart-data.ts)
Will be created in Wave 1 - assume exists

## Existing Code
@src/types/index.ts
@src/lib/storage.ts
@src/lib/money.ts
@src/lib/date.ts
@src/app/(dashboard)/monthly/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trend comparison chart component with time range selector</name>
  <files>
    src/components/charts/trend-comparison.tsx
  </files>
  <action>
Create `src/components/charts/trend-comparison.tsx` with Recharts line chart:

Use 'use client' directive (Recharts requires client-side)

Import:
- ResponsiveContainer, LineChart, Line, XAxis, YAxis, Legend from 'recharts'
- aggregateByMonth from @/lib/chart-data
- formatIDR from @/lib/money
- useState, useMemo from 'react'
- getTransactions from @/lib/storage

Component structure:

1. State management:
   - `timeRange` state: '3' | '6' | '12' (default '3')
   - Native select dropdown for time range selection

2. Data aggregation with useMemo:
   - Load all transactions via getTransactions()
   - Use aggregateByMonth(transactions, parseInt(timeRange)) to get monthly data
   - Memoize based on [timeRange] dependency
   - Result: array of { month: string, income: number, expense: number, net: number }

3. Metrics calculation (also memoized):
   - Calculate percentage change: compare last month expense vs previous month
   - Calculate average spending: sum all expense values / month count
   - Format as "+15%" or "-10%" for percentage change
   - Format average with formatIDR

4. Chart configuration (following user decisions):
   - ResponsiveContainer with width="100%" height={300}
   - LineChart with data from aggregateByMonth
   - XAxis with dataKey="month" (format as "MMM YYYY" via date-fns)
   - YAxis (can use formatIDR for tick labels if desired)
   - Two Line components:
     - Line for "expense" with stroke color (e.g., red-ish #ef4444)
     - Line for "income" with stroke color (green-ish #22c55e)
   - Legend to distinguish Income vs Expense lines
   - type="monotone" for smooth line curves

5. Display metrics ABOVE chart:
   - Show percentage change vs previous month
   - Show average spending across time range
   - Use Tailwind text classes for styling

6. Empty state handling:
   - If monthData.length === 0, show message: "No data yet. Add expenses to see trends!"
   - Otherwise render chart (even with 1-2 months - no minimum threshold per user decision)

Styling: Use Tailwind for layout, spacing, and responsive design
  </action>
  <verify>
Check file exists and exports component:
```bash
grep -n "export.*TrendComparison" src/components/charts/trend-comparison.tsx
```

Verify time range selector and aggregation:
```bash
grep -n "aggregateByMonth" src/components/charts/trend-comparison.tsx
grep -n "select" src/components/charts/trend-comparison.tsx
```

TypeScript check:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
- src/components/charts/trend-comparison.tsx exists
- Component has time range selector dropdown (3/6/12 months)
- Component uses aggregateByMonth with useMemo for performance
- Chart displays Income and Expense as two separate lines
- Metrics show percentage change and average spending
- Empty state handled with friendly message
- Chart renders even with 1-2 months of data
- TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate trend chart into Monthly page below category chart</name>
  <files>
    src/app/(dashboard)/monthly/page.tsx
  </files>
  <action>
Update Monthly page to include trend comparison chart:

Import:
- TrendComparison from @/components/charts/trend-comparison

Layout structure (add to existing Monthly page):
- Keep existing month selector at top
- Keep existing summary cards
- Keep CategoryBreakdown chart (from Plan 02-01)
- Add new section BELOW CategoryBreakdown for TrendComparison chart
- Use Card component (shadcn/ui) to wrap trend chart with title "Spending Trends"
- Maintain responsive layout with Tailwind grid classes

Spacing:
- Use gap-6 or gap-8 between chart sections for visual breathing room
- Ensure both charts stack vertically on mobile, can be side-by-side on larger screens if space allows

Note: TrendComparison is self-contained with its own time range selector and data loading - no props needed from Monthly page
  </action>
  <verify>
Check Monthly page imports TrendComparison:
```bash
grep -n "TrendComparison" src/app/(dashboard)/monthly/page.tsx
```

Build check:
```bash
npm run build
```
Should complete without errors.
  </verify>
  <done>
- Monthly page imports and renders TrendComparison component
- Trend chart appears below category chart in responsive layout
- Build succeeds without errors
- Trend chart displays on Monthly page with time range selector
  </done>
</task>

</tasks>

<verification>
After task completion, verify phase goals:

1. Manual check: Run `npm run dev`, navigate to Monthly page
2. Verify trend line chart appears below category chart
3. Verify time range dropdown shows options: 3 months, 6 months, 12 months
4. Select different time ranges and verify chart updates
5. Verify two lines appear: Income (green) and Expense (red)
6. Verify percentage change and average metrics display above chart
7. Verify chart displays even with minimal data (test with 1-2 transactions)
8. Verify empty state message if no transactions exist
</verification>

<success_criteria>
- User sees trend line chart on Monthly page
- User can select time range (3/6/12 months) via dropdown
- Chart shows Income vs Expense as two separate lines
- Percentage change vs previous month displays
- Average spending across time range displays
- Chart renders even with only 1-2 months of data
- Empty state shows friendly message when no data exists
</success_criteria>

<output>
After completion, create `.planning/phases/02-dashboard-visualization/02-02-SUMMARY.md`
</output>
